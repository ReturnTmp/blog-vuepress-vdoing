---
title: SPM 埋点
date: 2023-11-26 21:40:23
permalink: /pages/83f78d/
categories:
  - 框架工具
tags:
  - 
author: 
  name: ReturnTmp
  link: https://github.com/ReturnTmp
---

## 前言

在微服务架构中，一个应用往往由多个服务组成，这些服务之间相互依赖，依赖关系错综复杂

例如一个微服务系统中存在 A、B、C、D、E、F 等多个服务，它们的依赖关系如下图：

![image.png](https://cdn.jsdelivr.net/gh/Returntmp/blog-image@main/blog/202311262209433.png)

通常情况下，一个用户请求往往需要多个服务配合才能完成。如图所示，在所有服务都处于可用状态时，请求 1 需要调用 A、D、E、F 四个服务才能完成，请求 2 需要调用 B、E、D 三个服务才能完成，请求 3 需要调用服务 C、F、E、D 四个服务才能完成

> 注：这种服务调用通常被称为 “扇出”（像一把打开的折扇）

假如服务 E 发生故障或网络延迟时，会出现以下情况：

1. 即使其他所有服务都可用，由于服务 E 的不可用，那么**用户请求 1、2、3 都会处于阻塞状态，等待服务 E 的响应**。在高并发的场景下，会导致整个服务器的**线程资源在短时间内迅速消耗殆尽**。
2. 所有依赖于服务 E 的其他服务，例如服务 B、D 以及 F 也都会处于线程阻塞状态，等待服务 E 的响应，导致这些服务的不可用。
3. 所有依赖服务B、D 和 F 的服务，例如服务 A 和服务 C 也会处于线程阻塞状态，以等待服务 D 和服务 F 的响应，导致服务 A 和服务 C 也不可用。

从上面过程可以看出，当微服务系统的一个服务出现故障时，故障会沿着服务的调用链路在系统中疯狂蔓延，最终导致整个微服务系统的瘫痪，这就是“**雪崩效应**”

为了防止此类事件的发生，微服务架构引入了“**熔断器**”的一系列服务容错和保护机制

> 注：**熔断器**（Circuit Breaker）一词来源物理学中的电路知识，它的作用是**当线路出现故障时，迅速切断电源以保护电路的安全**


## Hystrix

Spring Cloud Hystrix 是基于 Netflix 公司的开源组件 Hystrix 实现的，它提供了熔断器功能，能够有效地阻止分布式微服务系统中出现联动故障，以提高微服务系统的弹性。Spring Cloud Hystrix 具有服务降级、服务熔断、线程隔离、请求缓存、请求合并以及实时故障监控等强大功能。

在微服务系统中，Hystrix 能够帮助我们实现以下目标：  

- **保护线程资源**：防止单个服务的故障耗尽系统中的所有线程资源。
- **快速失败机制**：当某个服务发生了故障，不让服务调用方一直等待，而是直接返回请求失败。
- **提供降级（FallBack）方案**：在请求失败后，提供一个设计好的降级方案，通常是一个兜底方法，当请求失败后即调用该方法。
- **防止故障扩散**：使用熔断机制，防止故障扩散到其他服务。
- **监控功能**：提供熔断器故障监控组件 Hystrix Dashboard，随时监控熔断器的状态。


Hystrix 提供了服务降级功能，能够保证当前服务不受其他服务故障的影响，提高服务的健壮性。  
  
服务降级的使用场景有以下 2 种：

- 在服务器压力剧增时，根据实际业务情况及流量，对一些不重要、不紧急的服务进行有策略地不处理或简单处理，从而释放服务器资源以保证核心服务正常运作。
- 当某些服务不可用时，为了避免长时间等待造成服务卡顿或雪崩效应，而主动执行备用的降级逻辑立刻返回一个友好的提示，以保障主体业务不受影响。


Hystrix 服务降级 FallBack 既可以放在服务端进行，也可以放在客户端进行。  
  
Hystrix 会在以下场景下进行服务降级处理：

- 程序运行异常
- 服务超时
- 熔断器处于打开状态
- 线程池资源耗尽





## 参考链接

- [Hystrix：Spring Cloud服务熔断与降级组件 (biancheng.net)](https://c.biancheng.net/springcloud/hystrix.html)
- [大白话详解Spring Cloud服务降级与熔断-阿里云开发者社区 (aliyun.com)](https://developer.aliyun.com/article/1050387)



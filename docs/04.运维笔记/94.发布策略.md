---
title: 发布策略
date: 2023-12-22 10:23:34
permalink: /pages/1392d7/
categories:
  - 运维笔记
tags:
  - 
author: 
  name: ReturnTmp
  link: https://github.com/ReturnTmp
---




### 发布策略

#### 分类

蓝绿部署、滚动发布、灰度发布/金丝雀发布、红黑部署

#### 介绍

**蓝绿部署**，是指同时运行两个版本的应用，如上图所示，蓝绿部署的时候，并**不停止掉老版本**，而是**直接部署一套新版本**，等新版本运行起来后，再将流量切换到新版本上。但是蓝绿部署要求在升级过程中，同时运行两套程序，对硬件的要求就是日常所需的二倍，**硬件配置要求高**

**滚动发布**，能够解决掉蓝绿部署时对硬件要求增倍的问题。所谓**滚动升级**，就是在升级过程中，并不一下子启动所有新版本，是**先启动一台新版本**，**再停止一台老版本**，然后**再启动一台新版本**，**再停止一台老版本**，直到升级完成，这样的话，如果日常需要**10 台**服务器，那么升级过程中也就只需要**11 台**就行了。

但是滚动升级有一个问题，在开始滚动升级后，流量会直接流向已经启动起来的新版本，但是这个时候，新版本是不一定可用的，比如需要进一步的测试才能确认。那么在滚动升级期间，整个系统就处于非常**不稳定**的状态，如果发现了问题，也比较难以确定是新版本还是老版本造成的问题。

为了解决这个问题，我们需要为滚动升级实现**流量控制能力**。

**灰度发布/金丝雀发布**，起源是，矿井工人发现，金丝雀对瓦斯气体很敏感，矿工会在下井之前，先放一只金丝雀到井中，如果金丝雀不叫了，就代表瓦斯浓度高。

在灰度发布开始后，**先启动一个新版本应用**，但是并**不直接将流量切过来**，而是**测试人员**对新版本进行**线上测试**，启动的这个新版本应用，就是我们的金丝雀。如果没有问题，那么可以将**少量的用户流量导入到新版本**上，然后再对新版本做运行状态观察，**收集运行时数据**，如果此时对新旧版本做各种**数据对比**，就是所谓的**A/B 测试**。

**红黑部署**，与蓝绿部署类似，红黑部署也是通过两个集群完成软件版本的升级。

当前提供服务的所有机器都运行在红色集群 A 中，当需要发布新版本的时候，具体流程是这样的：

- 先在云上申请一个黑色集群 B，在 B 上部署新版本的服务；
- 等到 B 升级完成后，我们一次性地把负载均衡全部指向 B；
- 把 A 集群从负载均衡列表中删除，并释放集群 A 中所有机器。

这样就完成了一个版本的升级。

可以看到，与蓝绿部署相比，红黑部署只不过是充分利用了云计算的弹性伸缩优势，从而获得了两个收益：一是，简化了流程；二是，避免了在升级的过程中，由于只有一半的服务器提供服务，而可能导致的系统过载问题。




